<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CurryingUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcond</a> &gt; <a href="index.source.html" class="el_package">com.github.dakusui.pcond.experimentals.currying</a> &gt; <span class="el_source">CurryingUtils.java</span></div><h1>CurryingUtils.java</h1><pre class="source lang-java linenums">package com.github.dakusui.pcond.experimentals.currying;

import com.github.dakusui.pcond.experimentals.currying.context.CurriedContext;
import com.github.dakusui.pcond.experimentals.currying.multi.MultiFunction;
import com.github.dakusui.pcond.core.printable.PrintableFunctionFactory;

import java.util.List;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.IntStream;
import java.util.stream.Stream;

import static com.github.dakusui.pcond.internals.InternalUtils.formatObject;
import static java.util.Arrays.asList;
import static java.util.Collections.emptyList;
import static java.util.stream.Collectors.joining;

/**
 * Intended for internal use only.
 */
<span class="fc" id="L21">public enum CurryingUtils {</span>
  ;
<span class="fc" id="L23">  private static final ThreadLocal&lt;Function&lt;List&lt;Object&gt;, CurriedFunction&lt;Object, Object&gt;&gt;&gt; CURRIED_FUNCTION_FACTORY_POOL = new ThreadLocal&lt;&gt;();</span>

  public static CurriedFunction&lt;Object, Object&gt; curry(MultiFunction&lt;Object&gt; function) {
<span class="fc" id="L26">    return curry(function, emptyList());</span>
  }

  public static Function&lt;List&lt;Object&gt;, CurriedFunction&lt;Object, Object&gt;&gt; currier() {
<span class="fc bfc" id="L30" title="All 2 branches covered.">    if (CURRIED_FUNCTION_FACTORY_POOL.get() == null)</span>
<span class="fc" id="L31">      CURRIED_FUNCTION_FACTORY_POOL.set((List&lt;Object&gt; args) -&gt;</span>
<span class="fc" id="L32">          PrintableFunctionFactory.create(</span>
<span class="fc" id="L33">              (args_) -&gt; () -&gt; functionNameFormatter(functionName(args_), ongoingContext(args_)).apply(function(args_)), (args_) -&gt; new CurriedFunction.Impl(function(args_), ongoingContext(args_)), args, CurryingUtils.class</span>
          ));
<span class="fc" id="L35">    return CURRIED_FUNCTION_FACTORY_POOL.get();</span>
  }

  public static &lt;R&gt; Function&lt;CurriedContext, R&gt; applyCurriedFunction(CurriedFunction&lt;Object, Object&gt; curriedFunction, int... orderArgs) {
<span class="fc" id="L39">    return context -&gt; {</span>
<span class="fc" id="L40">      CurriedFunction&lt;?, ?&gt; cur = curriedFunction;</span>
<span class="fc" id="L41">      int[] normalizedOrderArgs = normalizeOrderArgs(context, orderArgs);</span>
<span class="fc bfc" id="L42" title="All 2 branches covered.">      for (int i = 0; i &lt; normalizedOrderArgs.length - 1; i++)</span>
<span class="fc" id="L43">        cur = cur.applyNext(context.valueAt(normalizedOrderArgs[i]));</span>
<span class="fc" id="L44">      return cur.applyLast(context.valueAt(normalizedOrderArgs[context.size() - 1]));</span>
    };
  }

  public static int[] normalizeOrderArgs(CurriedContext curriedContext, int[] orderArgs) {
    int[] order;
<span class="fc bfc" id="L50" title="All 2 branches covered.">    if (orderArgs.length == 0)</span>
<span class="fc" id="L51">      order = IntStream.range(0, curriedContext.size()).toArray();</span>
    else
<span class="fc" id="L53">      order = orderArgs;</span>
<span class="fc" id="L54">    return order;</span>
  }

  static CurriedFunction&lt;Object, Object&gt; curry(MultiFunction&lt;Object&gt; function, List&lt;? super Object&gt; ongoingContext) {
<span class="fc" id="L58">    return currier().apply(asList(function.name(), function, ongoingContext));</span>
  }

  private static String functionName(List&lt;Object&gt; args) {
<span class="fc" id="L62">    return (String) args.get(0);</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  private static MultiFunction&lt;Object&gt; function(List&lt;Object&gt; args) {
<span class="fc" id="L67">    return (MultiFunction&lt;Object&gt;) args.get(1);</span>
  }

  @SuppressWarnings(&quot;unchecked&quot;)
  private static List&lt;? super Object&gt; ongoingContext(List&lt;Object&gt; args) {
<span class="fc" id="L72">    return (List&lt;? super Object&gt;) args.get((2));</span>
  }

  private static Function&lt;MultiFunction&lt;Object&gt;, String&gt; functionNameFormatter(String functionName, List&lt;? super Object&gt; ongoingContext) {
<span class="fc" id="L76">    return (MultiFunction&lt;Object&gt; function) -&gt; functionName +</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">        (!ongoingContext.isEmpty() ? IntStream.range(0, ongoingContext.size())</span>
<span class="fc" id="L78">            .mapToObj(i -&gt; function.parameterType(i).getSimpleName() + &quot;:&quot; + ongoingContext.get(i))</span>
<span class="fc" id="L79">            .collect(joining(&quot;,&quot;, &quot;(&quot;, &quot;)&quot;)) : &quot;&quot;) +</span>
<span class="fc" id="L80">        IntStream.range(ongoingContext.size(), function.arity())</span>
<span class="fc" id="L81">            .mapToObj(i -&gt; &quot;(&quot; + function.parameterType(i).getSimpleName() + &quot;)&quot;)</span>
<span class="fc" id="L82">            .collect(joining());</span>
  }

  public static String formatParameterOrder(List&lt;Integer&gt; paramOrder) {
<span class="fc" id="L86">    String formatted = formatParamOrder(paramOrder.stream());</span>
<span class="fc" id="L87">    String uncustomized = formatParamOrder(IntStream.range(0, paramOrder.size()).boxed());</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">    return formatted.equals(uncustomized) ?</span>
        &quot;&quot; :
        formatted;
  }

  private static String formatParamOrder(Stream&lt;Integer&gt; paramOrderStream) {
<span class="fc" id="L94">    return paramOrderStream.map(Object::toString).collect(joining(&quot;,&quot;, &quot;(&quot;, &quot;)&quot;));</span>
  }

  static Supplier&lt;String&gt; messageInvalidTypeArgument(Object value, Class&lt;?&gt; aClass) {
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">    return () -&gt; &quot;Given argument:&quot; + formatObject(value) +</span>
        (value == null ?
            &quot;&quot; :
<span class="fc" id="L101">            &quot;(&quot; + value.getClass() + &quot;)&quot;) +</span>
<span class="fc" id="L102">        &quot; cannot be assigned to parameter:&quot; + aClass.getCanonicalName();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>