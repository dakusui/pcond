<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExceptionComposer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">pcond</a> &gt; <a href="index.source.html" class="el_package">com.github.dakusui.pcond.validator</a> &gt; <span class="el_source">ExceptionComposer.java</span></div><h1>ExceptionComposer.java</h1><pre class="source lang-java linenums">package com.github.dakusui.pcond.validator;

import com.github.dakusui.pcond.validator.exceptions.PostconditionViolationException;
import com.github.dakusui.pcond.validator.exceptions.PreconditionViolationException;
import com.github.dakusui.pcond.validator.exceptions.ValidationException;

import java.lang.reflect.InvocationTargetException;

import static com.github.dakusui.pcond.validator.ExceptionComposer.Utils.createException;
import static com.github.dakusui.pcond.validator.Explanation.reportToString;

/**
 * An interface to define how an exception is composed based on a given message,
 * a class of a condition that the value violates (non-null constraint, invalid state,
 * input validation), and the context the violation happened (pre-, post-condition check,
 * test-assertion, etc.).
 *
 * This interface has methods to return objects, each of which composes actual exceptions.
 * Each of them intended to group methods that compose exceptions for a single context.
 */
public interface ExceptionComposer {
  /**
   * Returns an instance to compose exceptions used with `requireXyz` methods in
   * {@code Requires} entry-point class of valid8j library.
   *
   * @return An object to compose exceptions for methods in {@code Requires}.
   */
  ForRequire forRequire();

  /**
   * Returns an instance to compose exceptions used with `ensureXyz` methods in
   * {@code Ensures} entry-point class of valid8j library.
   *
   * @return An object to compose exceptions for methods in {@code Ensures}.
   */
  ForEnsure forEnsure();

  /**
   * Returns an instance to compose exceptions used with `validateXyz` methods in
   * {@code Validates} entry-point class of valid8j library.
   *
   * @return An object to compose exceptions for methods in {@code Validates}.
   */
  ForValidate defaultForValidate();

  /**
   * Returns an instance to compose exceptions used in `assert` statements.
   *
   * @return An object to compose exceptions for &quot;precondition&quot; violation.
   */
  ForAssertion forAssert();

  /**
   * Returns an instance to compose exceptions used in `assertThat` and `assumeThat`
   * methods in {@code TestAssertions} entry-point class of thincrest library.
   * Other entry-point classes provided for use cases of the `pcond` library as
   * a test assertion library may also use this method.
   *
   * @return An object to compose exceptions for test assertions
   */
  ForTestAssertion forAssertThat();

  /**
   * An implementation of the {@link ExceptionComposer} interface.
   * You usually do not need to extend this method to customize its behavior.
   * Rather you only need to control the arguments passed to its constructor
   * through {@link Validator.Configuration.Builder}.
   *
   * @see Validator.Configuration
   * @see Validator.Configuration.Builder
   */
  class Impl implements ExceptionComposer {
    final private ForRequire       forRequire;
    final private ForEnsure        forEnsure;
    final private ForValidate      defaultForValidate;
    final private ForAssertion     forAssert;
    final private ForTestAssertion forAssertThat;

<span class="fc" id="L79">    public Impl(ForRequire forRequire, ForEnsure forEnsure, ForValidate defaultForValidate, ForAssertion forAssert, ForTestAssertion forAssertThat) {</span>
<span class="fc" id="L80">      this.forRequire = forRequire;</span>
<span class="fc" id="L81">      this.forEnsure = forEnsure;</span>
<span class="fc" id="L82">      this.defaultForValidate = defaultForValidate;</span>
<span class="fc" id="L83">      this.forAssert = forAssert;</span>
<span class="fc" id="L84">      this.forAssertThat = forAssertThat;</span>
<span class="fc" id="L85">    }</span>

    @Override
    public ForRequire forRequire() {
<span class="fc" id="L89">      return this.forRequire;</span>
    }

    @Override
    public ForEnsure forEnsure() {
<span class="fc" id="L94">      return this.forEnsure;</span>
    }

    @Override
    public ForValidate defaultForValidate() {
<span class="fc" id="L99">      return this.defaultForValidate;</span>
    }

    @Override
    public ForAssertion forAssert() {
<span class="fc" id="L104">      return this.forAssert;</span>
    }

    @Override
    public ForTestAssertion forAssertThat() {
<span class="fc" id="L109">      return this.forAssertThat;</span>
    }
  }

  /**
   * An interface that defines common methods that an object returned by each method
   * in the {@link ExceptionComposer} has.
   */
  interface Base {
    /**
     * A method to compose an exception for a &quot;Null-violation&quot;.
     * When you are checking a &quot;pre-condition&quot;, if the value must not be `null`,
     * you may prefer a {@link NullPointerException}, rather than an exception
     * such as `YourPreconditionException` as Google Guava's `Precondition` does
     * so.
     *
     * This method by default, returns a `NullPointerException`.
     *
     * In case you prefer to throw `YourPreconditionException` for the sake of uniformity,
     * you can override this method for an object returned by {@link ExceptionComposer#forRequire()}
     *
     * For more detail, please refer to {@link Validator.Configuration}.
     *
     * @param message A message attached to the composed exception.
     * @return A composed exception.
     */
    default Throwable exceptionForNonNullViolation(String message) {
<span class="fc" id="L136">      return new NullPointerException(message);</span>
    }

    /**
     * A method to compose an exception for a &quot;State-violation&quot;.
     *
     * @param message A message attached to the composed exception.
     * @return A composed exception.
     * @see Base#exceptionForNonNullViolation(String)
     */
    default Throwable exceptionForIllegalState(String message) {
<span class="fc" id="L147">      return new IllegalStateException(message);</span>
    }

    /**
     * A method to compose an exception for a general violation.
     * An extension-point to customize the exception to be thrown for a certain
     * context.
     *
     * @param message A message attached to the composed exception.
     * @return A composed exception.
     */
    Throwable exceptionForGeneralViolation(String message);
  }

  interface ForRequire extends Base {
    @Override
    default Throwable exceptionForGeneralViolation(String message) {
<span class="fc" id="L164">      return new PreconditionViolationException(message);</span>
    }

    Throwable exceptionForIllegalArgument(String message);

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L170">    class Default implements ForRequire {</span>
      @Override
      public Throwable exceptionForIllegalArgument(String message) {
<span class="fc" id="L173">        return new IllegalArgumentException(message);</span>
      }
    }
  }

  interface ForEnsure extends Base {
    @Override
    default Throwable exceptionForGeneralViolation(String message) {
<span class="fc" id="L181">      return new PostconditionViolationException(message);</span>
    }

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L185">    class Default implements ForEnsure {</span>
    }
  }

  interface ForValidate extends Base {
    @Override
    default Throwable exceptionForGeneralViolation(String message) {
<span class="fc" id="L192">      return new ValidationException(message);</span>
    }

    default Throwable exceptionForIllegalArgument(String message) {
<span class="fc" id="L196">      return new IllegalArgumentException(message);</span>
    }

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L200">    class Default implements ForValidate {</span>
    }
  }

  interface ForAssertion {
    default Throwable exceptionPreconditionViolation(String message) {
<span class="fc" id="L206">      return new AssertionError(message);</span>
    }

    default Throwable exceptionInvariantConditionViolation(String message) {
<span class="fc" id="L210">      return new AssertionError(message);</span>
    }

    default Throwable exceptionPostconditionViolation(String message) {
<span class="fc" id="L214">      return new AssertionError(message);</span>
    }

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L218">    class Default implements ForAssertion {</span>
    }
  }

  interface ForTestAssertion {
    &lt;T extends RuntimeException&gt; T testSkippedException(String message, ReportComposer reportComposer);

    default &lt;T extends RuntimeException&gt; T testSkippedException(Explanation explanation, ReportComposer reportComposer) {
<span class="nc" id="L226">      return testSkippedException(explanation.toString(), reportComposer);</span>
    }

    &lt;T extends Error&gt; T testFailedException(Explanation explanation, ReportComposer reportComposer);

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L232">    class JUnit4 implements ForTestAssertion {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
      @Override
      public &lt;T extends RuntimeException&gt; T testSkippedException(String message, ReportComposer reportComposer) {
<span class="fc" id="L236">        throw (T) createException(</span>
            &quot;org.junit.AssumptionViolatedException&quot;,
<span class="fc" id="L238">            reportComposer.explanationFromMessage(message),</span>
<span class="fc" id="L239">            (c, exp) -&gt; c.getConstructor(String.class).newInstance(exp.message()));</span>
      }

      @SuppressWarnings(&quot;unchecked&quot;)
      @Override
      public &lt;T extends Error&gt; T testFailedException(Explanation explanation, ReportComposer reportComposer) {
<span class="fc" id="L245">        throw (T) createException(</span>
            &quot;org.junit.ComparisonFailure&quot;,
            explanation,
<span class="fc" id="L248">            (c, exp) -&gt; c.getConstructor(String.class, String.class, String.class).newInstance(exp.message(), reportToString(exp.expected()), reportToString(exp.actual())));</span>
      }
    }

    @SuppressWarnings(&quot;unused&quot;) // Referenced reflectively
<span class="fc" id="L253">    class Opentest4J implements ForTestAssertion {</span>
      @SuppressWarnings(&quot;unchecked&quot;)
      @Override
      public &lt;T extends RuntimeException&gt; T testSkippedException(String message, ReportComposer reportComposer) {
<span class="fc" id="L257">        throw (T) createException(&quot;org.opentest4j.TestSkippedException&quot;, reportComposer.explanationFromMessage(message), (c, exp) -&gt;</span>
<span class="fc" id="L258">            c.getConstructor(String.class).newInstance(exp.message()));</span>
      }

      @SuppressWarnings(&quot;unchecked&quot;)
      @Override
      public &lt;T extends Error&gt; T testFailedException(Explanation explanation, ReportComposer reportComposer) {
<span class="fc" id="L264">        throw (T) createException(&quot;org.opentest4j.AssertionFailedError&quot;, explanation, (c, exp) -&gt;</span>
<span class="fc" id="L265">            c.getConstructor(String.class, Object.class, Object.class).newInstance(exp.message(), reportToString(exp.expected()), reportToString(exp.actual())));</span>
      }
    }
  }

<span class="fc" id="L270">  enum Utils {</span>
    ;

    @SuppressWarnings(&quot;unchecked&quot;)
    public static &lt;T extends Throwable&gt; T createException(String className, Explanation explanation, ReflectiveExceptionFactory&lt;T&gt; reflectiveExceptionFactory) {
      try {
<span class="fc" id="L276">        return reflectiveExceptionFactory.apply((Class&lt;T&gt;) Class.forName(className), explanation);</span>
<span class="nc" id="L277">      } catch (ClassNotFoundException e) {</span>
<span class="nc" id="L278">        throw new RuntimeException(&quot;FAILED TO INSTANTIATE EXCEPTION: '&quot; + className + &quot;' (NOT FOUND)&quot;, e);</span>
      }
    }

    @FunctionalInterface
    public
    interface ReflectiveExceptionFactory&lt;T extends Throwable&gt; {
      T create(Class&lt;T&gt; c, Explanation explanation) throws InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchMethodException;

      default T apply(Class&lt;T&gt; c, Explanation explanation) {
        try {
<span class="fc" id="L289">          return create(c, explanation);</span>
<span class="nc" id="L290">        } catch (InvocationTargetException | InstantiationException |</span>
            IllegalAccessException | NoSuchMethodException e) {
<span class="nc" id="L292">          throw new RuntimeException(&quot;FAILED TO INSTANTIATE EXCEPTION: '&quot; + c.getCanonicalName() + &quot;'&quot;, e);</span>
        }
      }
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>